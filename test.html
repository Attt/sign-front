<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="百度帐号是登录所有百度系产品的通行证，登录后还可以在帐户管理页管理/修改您的个人信息，包括修改密码、绑定手机、身份认证等">

    <title>百度登录</title>
    <link rel="stylesheet" type="text/css" href="css/login.style.css">
    <script type="application/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="application/javascript" src="js/jquery.cookie.js"></script>
</head>
<body>

<div id="content">
    <div class="login-header">
        <img src="http://www.baidu.com/img/baidu_jgylogo3.gif">
    </div>
    <form class="login-component">
        <div class="login-input-box">
            <span class="icon icon-user"></span>
            <input type="text" id="account" autocomplete="off" placeholder="账号">
        </div>
        <div class="login-input-box">
            <span class="icon icon-password"></span>
            <input type="password" id="password" onfocus="onPassfocus();" autocomplete="off" placeholder="密码">
        </div>
        <div class="login-input-box" id="vcodediv" style="display: none;">
            <span class="icon icon-vcode"></span>
            <input type="text" id="vcode" autocomplete="off"  placeholder="验证码" style="width: 240px;">
			<label id="vcodelabel"></label>
        </div>
        <div id="vcodeLoading" style="display: none;" class="loading">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
	</div>
    </form>
    <form class="verify-component" style="display: none;">
    	<div class="login-input-box">
            <label type="text" id="descri" style="padding-left: 22px;">检测到您在非常用设备上登录，请通过手机137******923短信验证</label>
        </div>
        <div style="width: 100%;display: inline-flex;padding-bottom: 20px;margin-top: 12px;">
            <input class="smscodeinput" autocomplete="off" type="text" id="smscode" />
            <button class="smscodebutton" id="smsButton" onclick="sendSms();">发送验证码</button>
        </div>
    </form>
    <img id="head" src="" style="display: none;"/>
    <label id="nickname" style="display: none;"></label>
    <div class="login-button-box-disable login-component logBtn">
        <button disabled="disabled" id="loginbutton" onclick="login();">登录百度</button>
    </div>
    <div class="loading loading-component">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
	</div>
</div>
</body>
<script>
		var onPassfocus;
		var codeStr;
		var uid;
		var bdcm;
		var serverTime;
		var gid;
		var ckeys;
		var lstr;
		var ltoken;
		var phone;
		var tbs;
		var clientid;
		var passLock = false;
		var account;
		$(function() {
			onPassfocus = function() {
				if(passLock){
					return;
				}
				if($("#account").val()&&account!=$("#account").val()) {
					$("#vcodelabel")[0].innerHTML = "";
					$("#vcodediv").hide();
					passLock = true;
					$("#vcodeLoading").show();
					var dat = {
							username:$("#account").val(),
							ckeys:ckeys
					};
					account = $("#account").val();
					$.ajax({
						url:"http://localhost:8999/baidu/check",
						type:"post",
						dataType:"json",        
            			contentType:"application/json",     
						data:JSON.stringify(dat),
						success:function(result){
							if(result.errno != '0'){
								alert(result.msg);
								return;
							}
							if(!result.codeString){
								alert("这个账号怕是不存在..");
								return;
							}
							serverTime = result.serverTime;
							codeStr = result.codeString;
							gid = result.gid;
							ckeys = result.ckeys;
							$("#vcodeLoading").hide();
							var imgsrc = "https://wappass.baidu.com/cgi-bin/genimage?"+codeStr+"&v=";
							var imgHtml = "<img id=\"vcodeImg\" style=\"width: 90px;padding-left: 10px;height: 36px;\" src=\"" + imgsrc + new Date().getTime() + "\" onclick=\"this.src='" + imgsrc + "'+new Date().getTime()\"/>";
							$("#vcodelabel").append(imgHtml);
							$("#vcodediv").show();
							$(".login-button-box-disable").addClass("login-button-box");
							$(".login-button-box").removeClass("login-button-box-disable");
							$("#loginbutton").removeAttr("disabled");
							passLock = false;
						},
						error:function(e){
							console.error(e);
						}
					});
					
				}
			}
			
			login = function(){
				var dat = {
					username:$("#account").val(),
					password:$("#password").val(),
					vcode:$("#vcode").val(),
					gid:gid,
					codeStr:codeStr,
					serverTime:serverTime,
					ckeys:ckeys
				};
				$.ajax({
						url:"http://localhost:8999/baidu/login",
						type:"post",
						dataType:"json",        
            			contentType:"application/json",     
						data:JSON.stringify(dat),
						success:function(result){
							if(result.errno === '400023'){
								//短信验证
								lstr = result.lstr;
								ltoken = result.ltoken;
								phone = result.phone;
								$(".login-component").hide();
								$(".logBtn").show();
								$(".verify-component").show();
								$(".login-button-box").addClass("login-button-box-disable");
								$(".login-button-box-disable").removeClass("login-button-box");
								$("#loginbutton").attr("disabled","disabled");
								$("#descri").text("检测到您在非常用设备上登录，请通过手机"+phone+"短信验证");
							}else if(result.errno === '500002'){
								alert("验证码错误")
							}else{
								alert(result.msg);
								return;
							}
							ckeys = result.ckeys;
						},
						error:function(e){
							console.error(e);
						}
					});
			}
			
			sendSms = function(){
				$(".smscodebutton").addClass("smscodebutton-disable");
				$(".smscodebutton-disable").removeClass("smscodebutton");
				$("#smsButton").attr("disabled","disabled");
				var countdown = 60;
				var interval = setInterval(function(){
					$("#smsButton").text("("+countdown+"s)")
					if(countdown==0){
						clearInterval(interval);
						$("#smsButton").text("发送验证码")
						$(".smscodebutton-disable").addClass("smscodebutton");
						$(".smscodebutton").removeClass("smscodebutton-disable");
						$("#smsButton").removeAttr("disabled");
					}
					countdown--;
				}, 1000);
				var dat = {
					gid:gid,
					lstr:lstr,
					ltoken:ltoken,
					ckeys:ckeys
				};
				
				$.ajax({
						url:"http://localhost:8999/baidu/sendSms",
						type:"post",
						dataType:"json",
            			contentType:"application/json",     
						data:JSON.stringify(dat),
						success:function(result){
							if(result.errno != '0'){
								alert(result.msg);
								return;
							}
							ckeys = result.ckeys;
							$(".login-button-box-disable").addClass("login-button-box");
							$(".login-button-box").removeClass("login-button-box-disable");
							$("#loginbutton").removeAttr("disabled");
							$("#loginbutton").attr("onclick","loginWithSms()");
						},
						error:function(e){
							console.error(e);
						}
					});
			}
			
			loginWithSms = function(){
				var dat = {
					gid:gid,
					lstr:lstr,
					ltoken:ltoken,
					ckeys:ckeys,
					vcode:$("#smscode").val()
				};
				$.ajax({
						url:"http://localhost:8999/baidu/loginWithSmsCode",
						type:"post",
						dataType:"json",        
            			contentType:"application/json",     
						data:JSON.stringify(dat),
						success:function(result){
							if(result.errno != '0'){
								alert(result.msg);
								return;
							}
							ckeys = result.ckeys;
							tbs = result.tbs;
							$.cookie('BDUSS', result.bduss, {expires: 7});
							$.cookie('PTOKEN', result.ptoken, {expires: 7});
							afterLogin(result.name,result.portrait);
						},
						error:function(e){
							console.error(e);
						}
					});
			}
			
			afterLogin = function(name,portrait){
				$(".verify-component").hide();
				$(".logBtn").hide();
				$("#head").attr("src",portrait);
				$("#nickname").text(name);
				$("#head").show();
				$("#nickname").show();
			}
			
			var dat = {
				BDUSS:$.cookie('BDUSS'),
				PTOKEN:$.cookie('PTOKEN'),
				clientid:$.cookie('CLIENTID')
			}
			$.ajax({
				url:"http://localhost:8999/baidu/prepare",
				type:"post",
				dataType:"json",        
            	contentType:"application/json",     
				data:JSON.stringify(dat),
				success:function(result){
					if(result.tbs){
						tbs = result.tbs;
						afterLogin(result.name,result.portrait);
						$(".loading-component").hide();
						return;
					}
					ckeys = result.ckeys;
					bdcm = result.bdcm;
					$.cookie('CLIENTID', result.wiseid, {expires: 7});
					uid = result.uid;
					$(".loading-component").hide();
					$(".login-component").show();
				},error:function(e){
					console.error(e);
				}
			});
		});
	</script>
</html>